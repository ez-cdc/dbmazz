name: Build and Release DBMazz

on:
  push:
    branches: [main]

env:
  COMPONENT: dbmazz
  S3_BUCKET: ez-cdc-releases
  GCS_BUCKET: ez-cdc-releases-gcp

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install protoc and musl tools
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler musl-tools pkg-config libssl-dev perl make jq

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build dbmazz for musl
        env:
          CARGO_TERM_COLOR: always
        run: cargo build --release --target x86_64-unknown-linux-musl --verbose

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Calculate next version from S3
        id: version
        run: |
          # List all version directories in S3 for this component
          VERSIONS=$(aws s3 ls "s3://${{ env.S3_BUCKET }}/${{ env.COMPONENT }}/" 2>/dev/null | grep -E '^\s*PRE\s+[0-9]+\.[0-9]+\.[0-9]+/' | awk '{print $2}' | tr -d '/' | sort -t. -k1,1n -k2,2n -k3,3n)

          if [ -z "$VERSIONS" ]; then
            # No versions exist, start at 0.1.0
            NEXT_VERSION="0.1.0"
          else
            # Get the latest version
            LATEST=$(echo "$VERSIONS" | tail -1)
            echo "Latest version in S3: $LATEST"

            # Parse and increment patch version
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST"
            NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
          fi

          echo "Next version: $NEXT_VERSION"
          echo "VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate checksum
        id: checksum
        run: |
          CHECKSUM=$(sha256sum target/x86_64-unknown-linux-musl/release/dbmazz | cut -d' ' -f1)
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Upload versioned binary to S3
        run: |
          # Upload to versioned path: s3://ez-cdc-releases/dbmazz/0.1.0/dbmazz-linux-amd64
          aws s3 cp target/x86_64-unknown-linux-musl/release/dbmazz \
            "s3://${{ env.S3_BUCKET }}/${{ env.COMPONENT }}/${{ steps.version.outputs.VERSION }}/dbmazz-linux-amd64"

          # Also upload checksum file
          echo "${{ steps.checksum.outputs.CHECKSUM }}  dbmazz-linux-amd64" > checksum.txt
          aws s3 cp checksum.txt \
            "s3://${{ env.S3_BUCKET }}/${{ env.COMPONENT }}/${{ steps.version.outputs.VERSION }}/SHA256SUMS"

      - name: Update latest binary in S3
        run: |
          # Update the latest path for quick access
          aws s3 cp target/x86_64-unknown-linux-musl/release/dbmazz \
            "s3://${{ env.S3_BUCKET }}/${{ env.COMPONENT }}/latest/dbmazz-linux-amd64"

          # Write version marker
          echo "${{ steps.version.outputs.VERSION }}" > version.txt
          aws s3 cp version.txt \
            "s3://${{ env.S3_BUCKET }}/${{ env.COMPONENT }}/latest/VERSION"

      # =====================================================================
      # Upload to GCS (GCP)
      # =====================================================================
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload versioned binary to GCS
        run: |
          gsutil cp target/x86_64-unknown-linux-musl/release/dbmazz \
            "gs://${{ env.GCS_BUCKET }}/${{ env.COMPONENT }}/${{ steps.version.outputs.VERSION }}/dbmazz-linux-amd64"

          echo "${{ steps.checksum.outputs.CHECKSUM }}  dbmazz-linux-amd64" > checksum.txt
          gsutil cp checksum.txt \
            "gs://${{ env.GCS_BUCKET }}/${{ env.COMPONENT }}/${{ steps.version.outputs.VERSION }}/SHA256SUMS"

      - name: Update latest binary in GCS
        run: |
          gsutil cp target/x86_64-unknown-linux-musl/release/dbmazz \
            "gs://${{ env.GCS_BUCKET }}/${{ env.COMPONENT }}/latest/dbmazz-linux-amd64"

          echo "${{ steps.version.outputs.VERSION }}" > version.txt
          gsutil cp version.txt \
            "gs://${{ env.GCS_BUCKET }}/${{ env.COMPONENT }}/latest/VERSION"

      - name: Print deployment info
        run: |
          echo "Deployed dbmazz version: ${{ steps.version.outputs.VERSION }}"
          echo "Checksum (SHA256): ${{ steps.checksum.outputs.CHECKSUM }}"
          echo "Binaries available at:"
          echo "   AWS: s3://${{ env.S3_BUCKET }}/${{ env.COMPONENT }}/${{ steps.version.outputs.VERSION }}/dbmazz-linux-amd64"
          echo "   GCP: gs://${{ env.GCS_BUCKET }}/${{ env.COMPONENT }}/${{ steps.version.outputs.VERSION }}/dbmazz-linux-amd64"
